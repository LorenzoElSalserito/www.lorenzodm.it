{# File: user/themes/lorenzodm/templates/partials/base.html.twig #}
<!DOCTYPE html>
<html lang="{{ grav.language.getActive ?: 'it' }}" data-theme="{{ theme_config.style|default('light') }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    {# Titolo e Meta Tags #}
    <title>{% if header.title %}{{ header.title|e('html') }} | {% endif %}{{ site.title|default('lorenzodm.it')|e('html') }}</title>
    
    {# Meta Tags per SEO #}
    <meta name="description" content="{{ page.header.description|default(site.metadata.description) }}">
    <meta name="keywords" content="{{ page.header.keywords|default(site.metadata.keywords) }}">
    <meta name="author" content="{{ site.metadata.author|default('Lorenzo DM') }}">
    <meta name="robots" content="index, follow">
    
    {# Meta Tags per Open Graph (Facebook) #}
    <meta property="og:title" content="{{ page.header.og_title|default(page.title ~ ' | ' ~ site.title|default('lorenzodm.it')) }}">
    <meta property="og:description" content="{{ page.header.og_description|default(page.header.description|default(site.metadata.description)) }}">
    <meta property="og:url" content="{{ page.url(true, true) }}">
    <meta property="og:type" content="{{ page.header.og_type|default('website') }}">
    <meta property="og:image" content="{{ page.header.og_image|default('theme://images/banner-liberta-digitale.jpg')|absolute_url }}">
    <meta property="og:site_name" content="lorenzodm.it">
    <meta property="og:locale" content="it_IT">
    
    {# Meta Tags per Twitter #}
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ page.header.twitter_title|default(page.title ~ ' | ' ~ site.title|default('lorenzodm.it')) }}">
    <meta name="twitter:description" content="{{ page.header.twitter_description|default(page.header.description|default(site.metadata.description)) }}">
    <meta name="twitter:image" content="{{ page.header.twitter_image|default('theme://images/banner-liberta-digitale.jpg')|absolute_url }}">
    <meta name="twitter:site" content="@lorenzodm">
    
    {# URL Canonico #}
    <link rel="canonical" href="{{ page.url(true, true) }}">
    
    {# Favicon e icone #}
    <link rel="shortcut icon" type="image/png" href="{{ url('theme://images/favicon.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url('theme://images/apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url('theme://images/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url('theme://images/favicon-16x16.png') }}">
    <link rel="manifest" href="{{ url('theme://site.webmanifest') }}">
    
    {# Preconnect per CDN e performance #}
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="dns-prefetch" href="https://www.youtube.com">
    <link rel="dns-prefetch" href="https://t.me">
    
    {# CSS tramite Asset Manager #}
    {{ assets.css()|raw }}
    
    {# CSS per Cookie Popup #}
    <link rel="stylesheet" href="{{ url('theme://css/cookie-popup.css') }}">
    
    {# Risoluzione diretta della banda bianca con CSS inline #}
    <style>
        html, body {
            margin: 0 !important;
            padding: 0 !important;
            overflow-x: hidden;
        }
        body {
            padding-top: 56px !important; /* Spazio per navbar fissa */
        }
        .navbar {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            width: 100% !important;
            z-index: 1000 !important;
        }
        .banner-container {
            margin: 0 !important;
            padding: 0 !important;
            font-size: 0 !important;
            line-height: 0 !important;
        }
        .banner-image {
            display: block !important;
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
        }
    </style>
    
    {# Google Analytics 4 con gestione consenso cookies #}
    {% if theme_config.google_analytics_id %}
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ theme_config.google_analytics_id }}"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        
        // Configura Analytics con consenso inizialmente negato
        gtag('consent', 'default', {
            'analytics_storage': 'denied',
            'ad_storage': 'denied',
            'wait_for_update': 500,
        });
        
        gtag('js', new Date());
        gtag('config', '{{ theme_config.google_analytics_id }}', {
            'anonymize_ip': true,
            'respect_dnt': true
        });
    </script>
    {% endif %}
    
    {# Schema.org markup per SEO #}
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "name": "{{ site.title|default('lorenzodm.it') }}",
        "url": "{{ base_url_absolute }}",
        "description": "{{ site.metadata.description }}",
        "inLanguage": "it",
        "author": {
            "@type": "Person",
            "name": "Lorenzo DM",
            "url": "{{ base_url_absolute }}",
            "sameAs": [
                "{{ theme_config.social_media.youtube|default('https://www.youtube.com/@LorenzoDM/videos?sub_confirmation=1') }}",
                "{{ theme_config.social_media.telegram_personal|default('https://t.me/Lorenzo_DM') }}",
                "{{ theme_config.social_media.mastodon|default('https://mastodon.uno/@lorenzodm') }}"
            ]
        },
        "publisher": {
            "@type": "Organization",
            "name": "lorenzodm.it",
            "url": "{{ base_url_absolute }}",
            "logo": {
                "@type": "ImageObject",
                "url": "{{ url('theme://images/lorenzodm-logo.png')|absolute_url }}"
            }
        },
        "potentialAction": {
            "@type": "SearchAction",
            "target": "{{ base_url_absolute }}/search?q={search_term_string}",
            "query-input": "required name=search_term_string"
        }
    }
    </script>
    
    {# Schema.org markup Organization per SEO #}
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "lorenzodm.it",
        "url": "{{ base_url_absolute }}",
        "logo": "{{ url('theme://images/lorenzodm-logo.png')|absolute_url }}",
        "description": "Divulgazione su libertà digitale, software libero e tecnologia open source",
        "foundingDate": "2020",
        "founder": {
            "@type": "Person",
            "name": "Lorenzo DM"
        },
        "contactPoint": {
            "@type": "ContactPoint",
            "contactType": "customer service",
            "email": "info@lorenzodm.it",
            "availableLanguage": "Italian"
        },
        "sameAs": [
            "{{ theme_config.social_media.youtube|default('https://www.youtube.com/@LorenzoDM/videos?sub_confirmation=1') }}",
            "{{ theme_config.social_media.telegram_personal|default('https://t.me/Lorenzo_DM') }}",
            "{{ theme_config.social_media.mastodon|default('https://mastodon.uno/@lorenzodm') }}"
        ],
        "areaServed": "IT",
        "knowsAbout": [
            "Software Libero",
            "Open Source",
            "Libertà Digitale",
            "Privacy Online",
            "Sicurezza Informatica"
        ]
    }
    </script>
    
    {# Structured Data per Breadcrumb se applicabile #}
    {% if page.header.breadcrumb is not defined or page.header.breadcrumb %}
        {% set breadcrumb_list = [] %}
        {% set breadcrumb_list = breadcrumb_list|merge([{
            '@type': 'ListItem',
            'position': 1,
            'name': 'Home',
            'item': base_url_absolute
        }]) %}
        
        {% if page.parent and page.parent.title != 'Root' %}
            {% set breadcrumb_list = breadcrumb_list|merge([{
                '@type': 'ListItem',
                'position': 2,
                'name': page.parent.title,
                'item': page.parent.url(true, true)
            }]) %}
        {% endif %}
        
        {% if page.title and page.url != base_url %}
            {% set position = breadcrumb_list|length + 1 %}
            {% set breadcrumb_list = breadcrumb_list|merge([{
                '@type': 'ListItem',
                'position': position,
                'name': page.title,
                'item': page.url(true, true)
            }]) %}
        {% endif %}
        
        {% if breadcrumb_list|length > 1 %}
        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "BreadcrumbList",
            "itemListElement": {{ breadcrumb_list|json_encode|raw }}
        }
        </script>
        {% endif %}
    {% endif %}
</head>
<body>
    {# Skip link per accessibilità #}
    <a href="#main-content" class="skip-link">Salta al contenuto</a>
    
    {# Navbar fissa #}
    {% include 'partials/navigation.html.twig' %}

    {# Contenuto principale #}
    <main id="main-content" role="main">
        {% block content %}{% endblock %}
    </main>

    {# Footer #}
    {% include 'partials/footer.html.twig' %}
    
    {# JavaScript tramite Asset Manager #}
    {{ assets.js('bottom')|raw }}
    
    {# JavaScript per Cookie Popup #}
    <script src="{{ url('theme://js/cookie-popup.js') }}" defer></script>
    
    {# TEST COOKIE POPUP - VERSIONE CORRETTA #}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🧪 TEST: Verifica caricamento file cookie popup');
        
        // Verifica CSS
        setTimeout(function() {
            var cssLoaded = document.querySelector('link[href*="cookie-popup.css"]');
            console.log('CSS cookie-popup.css:', cssLoaded ? '✅ Trovato nel DOM' : '❌ NON trovato nel DOM');
            
            // Verifica JS
            if (typeof SimpleCookieManager !== 'undefined') {
                console.log('✅ SimpleCookieManager caricato correttamente!');
            } else {
                console.log('❌ SimpleCookieManager NON caricato - caricamento manuale...');
                loadCookieManually();
            }
        }, 2000);
        
        function loadCookieManually() {
            console.log('📥 Caricamento manuale cookie popup...');
            
            // CSS manuale
            var cssLink = document.createElement('link');
            cssLink.rel = 'stylesheet';
            cssLink.href = '/user/themes/lorenzodm/css/cookie-popup.css';
            cssLink.onload = function() { console.log('✅ CSS caricato manualmente'); };
            cssLink.onerror = function() { console.log('❌ Errore caricamento CSS'); };
            document.head.appendChild(cssLink);
            
            // JS manuale
            var jsScript = document.createElement('script');
            jsScript.src = '/user/themes/lorenzodm/js/cookie-popup.js';
            jsScript.onload = function() {
                console.log('✅ JS caricato manualmente');
                setTimeout(function() {
                    if (typeof SimpleCookieManager !== 'undefined') {
                        console.log('🎉 Cookie popup funziona!');
                    } else {
                        console.log('❌ Errore nel JS - mostro banner emergenza');
                        showEmergencyBanner();
                    }
                }, 1000);
            };
            jsScript.onerror = function() {
                console.log('❌ Errore caricamento JS - banner emergenza');
                showEmergencyBanner();
            };
            document.body.appendChild(jsScript);
        }
        
        function showEmergencyBanner() {
            // Verifica se già accettato
            var emergencyConsent = localStorage.getItem('lorenzodm_emergency_cookies');
            if (emergencyConsent) {
                console.log('🍪 Consenso emergenza già dato');
                return;
            }
            
            console.log('🚨 Mostro banner cookie di emergenza');
            
            var banner = document.createElement('div');
            banner.id = 'emergencyCookieBanner';
            banner.style.cssText = 'position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(135deg, #004aad 0%, #00be62 100%); color: white; padding: 20px; z-index: 9999; box-shadow: 0 -5px 15px rgba(0,0,0,0.3); font-family: Arial, sans-serif;';
            
            banner.innerHTML = '<div style="max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;"><div style="flex: 1; min-width: 300px;"><h4 style="margin: 0 0 5px 0; font-size: 1.2rem; font-weight: bold;">🍪 Cookie Notice - lorenzodm.it</h4><p style="margin: 0; font-size: 0.95rem;">Utilizziamo cookies per migliorare la tua esperienza di navigazione. Continuando accetti l\'uso dei cookies essenziali.</p></div><div style="display: flex; gap: 10px; flex-wrap: wrap;"><button onclick="acceptEmergencyCookies()" style="background: #00be62; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 600;">Accetta</button><button onclick="emergencyPrivacyPolicy()" style="background: transparent; color: white; border: 2px solid white; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-weight: 600;">Privacy Policy</button></div></div>';
            
            document.body.appendChild(banner);
            
            // Funzioni globali per il banner
            window.acceptEmergencyCookies = function() {
                localStorage.setItem('lorenzodm_emergency_cookies', JSON.stringify({
                    date: new Date().toISOString(),
                    accepted: true
                }));
                banner.remove();
                showSuccessMessage('Cookies accettati!');
            };
            
            window.emergencyPrivacyPolicy = function() {
                window.open('/privacy-policy', '_blank');
            };
            
            function showSuccessMessage(message) {
                var notification = document.createElement('div');
                notification.innerHTML = '✅ ' + message;
                notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #00be62 0%, #004aad 100%); color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 10001; font-weight: 600;';
                document.body.appendChild(notification);
                setTimeout(function() { notification.remove(); }, 3000);
            }
        }
    });
    </script>
    
    {# Script per il tema e interazioni #}
    <script>
        // Gestione eventi personalizzati per cookie consent
        document.addEventListener('cookieConsentUpdated', function(event) {
            const consent = event.detail.consent;
            
            // Aggiorna Google Analytics se consentito
            if (consent.analytics && consent.analytics.active && typeof gtag !== 'undefined') {
                gtag('consent', 'update', {
                    'analytics_storage': 'granted'
                });
                
                // Traccia evento di consenso
                gtag('event', 'cookie_consent_granted', {
                    'event_category': 'Privacy',
                    'event_label': 'Analytics Cookies',
                    'value': 1
                });
            }
            
            // Debug in sviluppo
            if (window.location.hostname === 'localhost' || window.location.hostname.includes('dev')) {
                console.log('Consent aggiornato:', consent);
            }
        });
        
        // Funzione di utilità per tracciare eventi solo se i cookies analytics sono accettati
        window.trackEvent = function(action, category, label, value) {
            if (typeof gtag !== 'undefined' && window.checkCookieConsent && window.checkCookieConsent('analytics')) {
                gtag('event', action, {
                    'event_category': category || 'User Interaction',
                    'event_label': label || '',
                    'value': value || 0
                });
            }
        };
        
        // Traccia click sui link esterni se i cookies analytics sono accettati
        document.addEventListener('click', function(event) {
            const link = event.target.closest('a');
            if (link && link.hostname !== window.location.hostname && window.checkCookieConsent && window.checkCookieConsent('analytics')) {
                const href = link.getAttribute('href');
                if (href && typeof gtag !== 'undefined') {
                    gtag('event', 'click', {
                        'event_category': 'Outbound Link',
                        'event_label': href,
                        'transport_type': 'beacon'
                    });
                }
            }
        });
        
        // Traccia scroll profondità se i cookies analytics sono accettati
        let scrollDepthTracked = [];
        window.addEventListener('scroll', function() {
            if (!window.checkCookieConsent || !window.checkCookieConsent('analytics') || typeof gtag === 'undefined') {
                return;
            }
            
            const scrollPercent = Math.round((window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100);
            const depths = [25, 50, 75, 100];
            
            depths.forEach(depth => {
                if (scrollPercent >= depth && !scrollDepthTracked.includes(depth)) {
                    scrollDepthTracked.push(depth);
                    gtag('event', 'scroll_depth', {
                        'event_category': 'User Engagement',
                        'event_label': depth + '%',
                        'value': depth
                    });
                }
            });
        });
    </script>
    
    {# Microdati per il footer #}
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WPFooter",
        "copyrightYear": "{{ "now"|date("Y") }}",
        "copyrightHolder": {
            "@type": "Organization",
            "name": "lorenzodm.it",
            "url": "{{ base_url_absolute }}"
        }
    }
    </script>
</body>
</html>